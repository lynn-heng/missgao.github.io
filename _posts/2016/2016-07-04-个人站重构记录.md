---
title: 也谈Pelican+Github博客搭建:个人站重构记录
date: 2016-07-04
category: linux
tags: pelican, github
slug: 2016-update-mysite
---

[TOC]

# 背景
以前站点使用jekyll部署，目前完全转至pelican部署，之前已经转移过一次，但当时仅仅是尝鲜。  
pelican是使用python编写的，自己现在工作中也要使用，所以转至pelican也算对口了吧。另外就是github虽然官方支持jekyll(按格式放入md文档即可生成站点），但是想要扩展一些功能的话github是不支持的，也就是插件功能被disable了，想要更多功能还需要在本地生成最终html部署，这样和pelican没什么区别。

## 所需知识及主要名词介绍
- **pelican**  
[Pelican](http://blog.getpelican.com/)是使用Python编写的开源的静态站点生成器, 不需要数据库及服务器端逻辑。 可以使用MarkDown、reStructuredText和AsiiDoc的格式来书写, 同时支持Disqus评论系统、代码高亮, 支持RSS和Atom输出；有很多现成的插件、主题可以选择；采用Jajin2模板引擎, 可以很容易的更改模板。  
本文使用的所描述的是pelican3.6.3版本

- **markdown**  
Markdown是一种可以使用普通文本编辑器编写的标记语言，通过简单的标记语法，它可以使普通文本内容具有一定的格式。  
Markdown具有一系列衍生版本，用于扩展Markdown的功能（如表格、脚注、内嵌HTML等等）。因为如此，pelican的md格式在一些markdown扩展功能方面和github是不同的：pelican使用的是Markdown Extra；github目前使用的是kramdown。应该是有方法将pelican转为kramdown的，但我目前没有这个想法 :-)

- **github**  
GitHub是一个利用Git进行版本控制、专门用于存放软件代码与内容的共享虚拟主机服务。它由GitHub公司（曾称Logical Awesome）的开发者Chris Wanstrath、PJ Hyett和Tom Preston-Werner使用Ruby on Rails编写而成。  
在这里我们主要使用[github pages](https://pages.github.com/)来创建静态站点：静态站点有很多的功能限制，所以感觉比较适合不怕折腾或者对站点功能要求不多的人使用。

- **git**  
git是一个分散式版本控制软件，最初由Linus Torvalds创作，于2005年以GPL发布。最初目的是为更好地管理Linux内核开发而设计。在这里我们需要掌握一些基本的git命令，init、add、push、commit等。

- **disqus**  
Disqus是一家使用社交网络形式，向网络社区提供网站留言服务的公司。  
由于静态站的特点，pelican无法实现留言功能，这里借助disqus来实现。

# 部署过程  
我自己的环境是archlinux,编辑md文件使用retext、vim。由于archlinux的源中已经有pelican，所以没有使用pip的方法安装。

## 环境安装

```bash
pacman -S pelican python-markdown python-beautifulsoup4
#如果是其它linux环境可使用如下命令（未验证）
pip install pelican
pip install markdown
pip install beautifulsoup4
```

## 结构生成

```bash
mkdir mysite
cd mysite
pelican-quickstart
```

根据提示一步步输入相应的配置项，不知道如何设置的接受默认即可，后续可以通过编辑pelicanconf.py文件更改配置)

```bash
> What will be the default language of this web site? [en] #这里填cn
> What is your time zone? [Europe/Paris] #这里填Asia/Shanghai
```

以下是生成的目录结构：

```bash
[nemo@HENG mysite]$ tree
.
├── content             # 存放源文件(md文件）
│   └── pages           # 存放手工创建的静态页面，该目录默认未创建，配合DISPLAY_PAGES_ON_MENU设置可以做类似about的页面
├── develop_server.sh   # 方便开启测试服务器
├── Makefile            # 方便管理博客的Makefile
├── output              # 生成的输出文件，最终将该目录部署至github pages
├── pelicanconf.py      # 主配置文件
└── publishconf.py      # 发布配置文件，覆盖pelicanconf的配置，可以将一些发布时才需要的设置加入
```

## 写一篇文章
使用文本编辑器（我使用retext)创建一篇文件存入content下，以markdown格式为例，文件头加入以下信息：

```
Title: 文章标题
Date: 2010-12-03 10:20
Modified: 2010-12-05 19:30 # 新文档这一行可以不写
Category: Python
Tags: pelican, publishing
Slug: my-super-post       # 标识文章唯一性，如果该项不填则使用title的中文拼音，如果发生唯一性冲突时则生成文档时会报错
Authors: Alexis Metaireau # 逗号分隔多个，这一行我一般不写
Summary: Short version for index and feeds  # 这个我平时也不用

This is the content of my super blog post.
```

上面#号及后面内容是说明，实际创建不要加入，否则会报错

## 本地查看
在站点目录下执行如下命令

```bash
make html
make serve
```
第一条命令将在output目录下生成静态站点，第二条命令启动本地http服务，可以使用http://localhost:8000查看

# 发布至github pages
可以参看[github pages](https://pages.github.com/)的介绍

1. 进入github.com,创建一个账号
2. 创建一个repository(仓库），名称使用yourname.github.io
3. ssh认证，本步不设置时使用git需要每次输入账号和密码
4. git clone站点至某目录

        git clone https://github.com/yourname/yourname.github.io

5. 将output目录内容放入clone出来的目录内，然后使用如下命令提交

        git add .
        git commit -m "init"
        git push origin master

6. [绑定自己的域名](https://help.github.com/articles/quick-start-setting-up-a-custom-domain/)

这里关于github及git命令的使用暂不做详细介绍，因为我自己对git还有不是十分熟练，只会几条基本命令。网上也有很多文章，以后如果有时间再来完善这一部分。  
另外我没有使用pelican的make publish命令，因为发现有问题。我将MakeFile做了下简单修改，使用该命令只是将内容输入至publish目录（output目录输出的是本机调试部分，一些关于publishconf.py的配置是不引用的），然后再使用第5步中的命令手动提交。
___
** 至此主要功能已完成，下面做一些美化工作  **

# 完善美化
pelican默认的站点simple样式过于简单，并且很多想要的功能也没有。另外我在archlinux下安装时pelican在系统的python目录下，操作也不是很方便(需要root权限修改)，所以需要进行一些美化工作。  
首先修改下默认的配置文件pelicanconf.py：加入代码高亮及目录（toc）功能

    MD_EXTENSIONS = ['codehilite(css_class=highlight)','extra', 'toc']

## 更换主题
[pelican仓库](https://github.com/getpelican/pelican-themes)上有很多现成的主题可以选择，官方的方法让将theme仓库clone至本机，然后选择自己需要的，但我只需要一个，所以使用svn方法来获取，我使用tuxlite_tbs主题。

```bash
mkdir themes
cd themes
svn co https://github.com/getpelican/pelican-themes/trunk/tuxlite_tbs
```

然后修改pelicanconf.py，加入或修改THEME

```python
THEME = 'themes/tuxlite_tbs'
```

## 评论(disqus)
编辑publishconf.py,查找DISQUS_SITENAME变量，将前面的#注释去掉（如果没有则添加该行）。注意这里修改在本机是看不到效果的，因为这个需要使用make publish时才会生效，如果想在本机查看，同时修改pelicanconf.py文件

```python
DISQUS_SITENAME = "missgao"  # 将missgao替换为自己在disqus站点的名称
```

## 统计（百度）
pelican默认有google的统计，但考虑到国内的网络环境，还是换成了百度统计。

1. 编辑publishconf.py，将GOOGLE_ANALYTICS行修改为下面行

        BAIDU_ANALYTICS = "5f98555052c4e3c64755c6406754××××"

    上面的一串值可以在百度统计中的生成部署代码中如下行找到

        hm.src = "//hm.baidu.com/hm.js?5f98555052c4e3c64755c6406754××××";

2. 修改主题文件themes/tuxlite_tbs/templates/analytics.html

    参考原来的内容，更换为百度统计中的代码

## 插件
我目前使用了两个插件：related_posts（相关文章）、tipue_search（站内搜索），以后可能会有变动，该文档可能未及时更新。以下记录主要修改内容。  
编辑pelicanconf.py，加入或修改如下内容：

```python
PLUGIN_PATHS = ['plugins']
PLUGINS = ['related_posts', 'tipue_search']
# RELATED_POSTS_MAX = 6
DIRECT_TEMPLATES = ['index', 'tags', 'categories', 'authors', 'archives', 'search']
```

- ### 搜索
该插件需安装beautifulsoup4，参看**环境安装**
    1. 获取插件

            mkdir plugins  # 对应上面PLUGIN_PATHS
            cd plugins
            svn co https://github.com/getpelican/pelican-plugins/trunk/tipue_search

    2. 获取样式文件

            cd themes/tuxlite_tbs/static
            svn co https://github.com/Tipue/Tipue-Search/trunk/tipuesearch

    3. 新建模板文件themes/tuxlite_tbs/templates/search.html,内容如下

            {% raw %}
            {% extends "base.html" %}
            
            {% block title %}
              Seach {{ super() }}
            {% endblock title %}
            
            {% block head_description %}
              Search results:
            {% endblock head_description %}
            
                {% block extra_css %}
              <link rel="stylesheet" href="{{ SITEURL }}/theme/tipuesearch/tipuesearch.css" />
            {% endblock %}
            
            {% block extra_js %}
              <script src="{{ SITEURL }}/theme/tipuesearch/tipuesearch_content.js"></script>
              <script src="{{ SITEURL }}/theme/tipuesearch/tipuesearch_set.js"></script>
              <script src="{{ SITEURL }}/theme/tipuesearch/tipuesearch.min.js"></script>
            
              <script>
                $(document).ready(function() {
                  $('#tipue_search_input').tipuesearch({
                      'mode' : 'json',
                      'show': 6,
                      'newWindow': false,
                      'contentLocation': '{{ SITEURL }}/tipuesearch_content.json'
                  });
                });
              </script>
            {% endblock extra_js %}
            
            {% block content %} 
              <h1>
                Search Results
              </h1>
              <hr />
              <div>
                <div id="tipue_search_content"></div>
              </div>
            {% endblock content %}
            {% endraw %}

    4. 修改模板文件themes/tuxlite_tbs/templates/site.html,在DISPLAY_PAGES_ON_MENU代码块后面加入

            {% raw %}
            <form class="navbar-search pull-right" action="{{ SITEURL }}/search.html" onsubmit="return validateForm(this.elements['q'].value);">
              <input type="text" name="q" id="tipue_search_input" class="search-query col-md-2" placeholder="Search" required/>
              <i class="fa fa-search fa-fw"></i>
            </form>
            {% endraw %}

        另外还需要在部分位置定义head_description、extra_css、extra_js的block，用以加入search中对应的block

    5. 修改配置文件：参看上面DIRECT_TEMPLATES行，加入search

- ### 相关文章
    1. 获取插件

            cd plugins  
            svn co https://github.com/getpelican/pelican-plugins/trunk/related_posts

    2. 修改模板文件themes/tuxlite_tbs/templates/article.html，在合适位置加入如下行

            {% raw %}
            {% if article.related_posts %}
                <ul>
                {% for related_post in article.related_posts %}
                    <li><a href="{{ SITEURL }}/{{ related_post.url }}">{{ related_post.title }}</a></li>
                {% endfor %}
                </ul>
            {% endif %}
            {% endraw %}

## pages页(about)
在content/pages下创建一个about.md文件,内容如下

    title: About Me
    date: 2016-07-04

    About me content

如果pelicanconf.py配置文件中DISPLAY_PAGES_ON_MENU不存在或设为True，则在页面顶部将显示about菜单项,对应该文件

# 想要更多
如果你的英文能力还可以，你还可以

- 前住[pelican的文档页](http://docs.getpelican.com/en/3.6.3/)查看更详细描述
- 前往[github pages页](https://pages.github.com/)查看自定义域名及静态站部署相关知识
- 前往[pelican themes仓库](https://github.com/getpelican/pelican-themes)获取更多主题
- 前往[pelican plugins仓库](https://github.com/getpelican/pelican-plugins)获取更多插件
- 前往[jinin2站点](http://jinja.pocoo.org/)查看模板语法
